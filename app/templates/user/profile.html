{% extends '../page_base.html' %}
{% load static %}

{% block title %}My Profile - The Sync Point{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/user/profile.css' %}">
{% endblock %}

{% block main %}
<div class="profile-container">
    <!-- Profile Header -->
    <div class="profile-header">
        <h1>My Profile</h1>
        <p>Manage your account and view your blog posts</p>
    </div>

    <div class="profile-wrapper">

        <!-- Profile Sidebar (30%) -->
        <aside class="profile-sidebar">
            <h2 class="sidebar-title">Profile</h2>
            
            <!-- Profile Picture -->
            <div class="profile-picture">
                {% if user.profile_picture %}
                <img src="{{ user.profile_picture.url }}" alt="{{ user.username }}">
                {% else %}
                <img src="{% static 'images/default-profile.jpg' %}" alt="Default Profile">
                {% endif %}
            </div>
            
            <!-- Profile Information -->
            <div class="profile-info">
                <div class="info-item">
                    <div class="info-label">Username</div>
                    <div class="info-value username">{{ user.username }}</div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">Full Name</div>
                    <div class="info-value">{{ user.get_full_name|default:"Not set" }}</div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">Email</div>
                    <div class="info-value">{{ user.email }}</div>
                </div>
                
                {% if user.bio %}
                <div class="info-item">
                    <div class="info-label">Bio</div>
                    <div class="info-value">{{ user.bio }}</div>
                </div>
                {% endif %}
                
                {% if user.phone_number %}
                <div class="info-item">
                    <div class="info-label">Phone</div>
                    <div class="info-value">{{ user.phone_number }}</div>
                </div>
                {% endif %}
            </div>
            
            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-number">{{ user.blog_posts.count }}</div>
                    <div class="stat-label">Posts</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">{{ total_likes }}</div>
                    <div class="stat-label">Total Likes</div>
                </div>
            </div>
            
            <!-- Profile Actions -->
            <div class="profile-actions">
                <a href="{% url 'logout' %}" class="profile-btn logout-btn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
                <a href="{% url 'edit_profile' %}" class="profile-btn edit-profile-btn">
                    <i class="fas fa-edit"></i> Edit Profile
                </a>
                <button class="profile-btn delete-btn" onclick="confirmDeleteAccount()">
                    <i class="fas fa-trash"></i> Delete Account
                </button>
            </div>
        </aside>

        <!-- Blogs Section (70%) -->
        <main class="blogs-section">
            <div class="section-header">
                <h2 class="section-title">My Blogs</h2>
                <span class="blogs-count">{{ user.blog_posts.count }} post{{ user.blog_posts.count|pluralize }}</span>
            </div>
            
            <!-- Status Filter Tabs -->
            <div class="status-filter">
                <button class="status-btn active" data-status="published">
                    <i class="fas fa-globe"></i> Published
                    <span class="status-count">{{ published_count }}</span>
                </button>
                <button class="status-btn" data-status="draft">
                    <i class="fas fa-edit"></i> Drafts
                    <span class="status-count">{{ draft_count }}</span>
                </button>
                <button class="status-btn" data-status="archived">
                    <i class="fas fa-archive"></i> Archived
                    <span class="status-count">{{ archived_count }}</span>
                </button>
            </div>
            
            <!-- Blog Cards -->
            <div class="blog-cards">
                {% if user.blog_posts.all %}
                    {% for blog in user.blog_posts.all %}
                    <article class="blog-card" data-status="{{ blog.status }}">
                        <div class="blog-header">
                            <div>
                                <h3 class="blog-title">{{ blog.title }}</h3>
                                <span class="blog-category">{{ blog.get_content_type_display }}</span>
                                <!-- Status Badge -->
                                <span class="status-badge status-{{ blog.status }}">
                                    <i class="fas 
                                        {% if blog.status == 'published' %}fa-globe
                                        {% elif blog.status == 'draft' %}fa-edit
                                        {% else %}fa-archive
                                        {% endif %}"></i>
                                    {{ blog.get_status_display }}
                                </span>
                            </div>
                            <div class="blog-date">
                                <i class="fas fa-calendar"></i>
                                {{ blog.created_at|date:"M d, Y" }}
                            </div>
                        </div>
                        
                        <div class="blog-meta">
                            <div class="meta-item">
                                <i class="fas fa-clock"></i>
                                <span>{{ blog.created_at|timesince }} ago</span>
                            </div>
                            <div class="meta-item">
                                <i class="fas fa-eye"></i>
                                <span>{{ blog.views_formatted }} views</span>
                            </div>
                        </div>
                        
                        <!-- Blog Stats (Only show for published posts) -->
                        {% if blog.status == 'published' %}
                        <div class="blog-stats">
                            <div class="blog-stat likes">
                                <div class="stat-icon">
                                    <i class="fas fa-thumbs-up"></i>
                                </div>
                                <div class="stat-count">{{ blog.likes_formatted }}</div>
                                <div class="stat-label-small">Likes</div>
                            </div>
                            
                            <div class="blog-stat dislikes">
                                <div class="stat-icon">
                                    <i class="fas fa-thumbs-down"></i>
                                </div>
                                <div class="stat-count">{{ blog.dislikes_formatted }}</div>
                                <div class="stat-label-small">Dislikes</div>
                            </div>
                            
                            <div class="blog-stat comments">
                                <div class="stat-icon">
                                    <i class="fas fa-comment"></i>
                                </div>
                                <div class="stat-count">{{ blog.comments.count|default:"0" }}</div>
                                <div class="stat-label-small">Comments</div>
                            </div>
                        </div>
                        {% else %}
                        <!-- Show placeholder for non-published posts -->
                        <div class="blog-stats-placeholder">
                            <p>Stats will be available after publishing</p>
                        </div>
                        {% endif %}
                        
                        <!-- Blog Actions -->
                        <div class="blog-actions">
                            {% if blog.status == 'published' %}
                            <a href="{% url 'blog_detail' blog.id %}" class="action-btn view-btn">
                                <i class="fas fa-eye"></i> View
                            </a>
                            {% else %}
                            <a href="{% url 'preview_blog' blog.id %}" class="action-btn view-btn">
                                <i class="fas fa-eye"></i> Preview
                            </a>
                            {% endif %}
                            
                            <a href="{% url 'edit_blog' blog.id %}" class="action-btn edit-btn">
                                <i class="fas fa-edit"></i> Edit
                            </a>
                            
                            <!-- Archive/Publish Actions using forms -->
                            {% if blog.status == 'published' %}
                                <button type="button" class="action-btn archive-bottom-btn" 
                                        onclick="showArchiveCard('{{ blog.id }}', '{{ blog.title|escapejs }}')">
                                    <i class="fas fa-archive"></i> Archive Blog
                                </button>
                            {% elif blog.status == 'archived' %}
                                <button type="button" class="action-btn publish-btn" 
                                        onclick="showPublishCard('{{ blog.id }}', '{{ blog.title|escapejs }}')">
                                    <i class="fas fa-paper-plane"></i> Publish
                                </button>
                            {% endif %}
                            
                            <!-- Delete Form -->
                            <button type="button" class="action-btn delete-btn-small" 
                                    onclick="showDeleteCard('{{ blog.id }}', '{{ blog.title|escapejs }}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </article>
                    {% endfor %}
                {% else %}
                    <!-- No Blogs Message -->
                    <div class="no-blogs">
                        <i class="fas fa-newspaper"></i>
                        <h3>No Blog Posts Yet</h3>
                        <p>You haven't created any blog posts. Start sharing your thoughts with the world!</p>
                        <a href="{% url 'write_blog' %}" class="create-blog-btn">
                            <i class="fas fa-plus"></i> Create Your First Blog
                        </a>
                    </div>
                {% endif %}
            </div>
            
        </main>

    </div>
</div>

<!-- Delete Confirmation Card  -->
<div id="deleteConfirmCard" class="confirm-card" style="display: none;">
    <div class="delete-card-content">
        <div class="delete-icon">
            <i class="fas fa-exclamation-triangle"></i>
        </div>
        <h3 class="delete-title">Delete Blog Post?</h3>
        <p class="delete-message" id="deleteBlogTitle">
            Are you sure you want to delete "<strong>Blog Title Here</strong>"?
        </p>
        <div class="delete-warning">
            <i class="fas fa-exclamation-circle"></i>
            <p>This action <strong>cannot be undone</strong>. The blog post and all its data (likes, comments, views) will be permanently removed.</p>
        </div>
        
        <!-- Hidden form to submit delete request -->
        <form id="deleteBlogForm" method="POST" action="">
            {% csrf_token %}
            <div class="delete-actions">
                <button type="button" class="cancel-delete-btn" onclick="hideDeleteCard()">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="submit" class="confirm-delete-btn">
                    <i class="fas fa-trash"></i> Yes, Delete
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Publish Confirmation Card -->
<div id="publishConfirmCard" class="confirm-card" style="display: none;">
    <div class="publish-card-content">
        <div class="publish-icon">
            <i class="fas fa-paper-plane"></i>
        </div>
        <h3 class="publish-title">Publish Blog Post?</h3>
        <p class="publish-message" id="publishBlogTitle">
            Are you ready to publish "<strong>Blog Title Here</strong>" to the world?
        </p>
        <div class="publish-info">
            <div class="info-row">
                <i class="fas fa-globe"></i>
                <span>Your blog will be visible to everyone</span>
            </div>
            <div class="info-row">
                <i class="fas fa-bell"></i>
                <span>Readers can like, comment, and share</span>
            </div>
            <div class="info-row">
                <i class="fas fa-chart-line"></i>
                <span>Views and engagement stats will start tracking</span>
            </div>
            <div class="info-row">
                <i class="fas fa-edit"></i>
                <span>You can still edit after publishing</span>
            </div>
        </div>
        
        <!-- Hidden form to submit publish request -->
        <form id="publishBlogForm" method="POST" action="">
            {% csrf_token %}
            <div class="publish-actions">
                <button type="button" class="cancel-publish-btn" onclick="hidePublishCard()">
                    <i class="fas fa-times"></i> Not Yet
                </button>
                <button type="submit" class="confirm-publish-btn">
                    <i class="fas fa-paper-plane"></i> Yes, Publish Now
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Archive Confirmation Card -->
<div id="archiveConfirmCard" class="confirm-card" style="display: none;">
    <div class="archive-card-content">
        <div class="archive-icon">
            <i class="fas fa-archive"></i>
        </div>
        <h3 class="archive-title">Archive Blog Post?</h3>
        <p class="archive-message" id="archiveBlogTitle">
            Are you sure you want to archive "<strong>Blog Title Here</strong>"?
        </p>
        <div class="archive-info">
            <div class="info-row">
                <i class="fas fa-eye-slash"></i>
                <span>Blog will be hidden from public view</span>
            </div>
            <div class="info-row">
                <i class="fas fa-save"></i>
                <span>All content and stats will be preserved</span>
            </div>
            <div class="info-row">
                <i class="fas fa-redo-alt"></i>
                <span>You can republish anytime</span>
            </div>
            <div class="info-row warning-row">
                <i class="fas fa-exclamation-triangle"></i>
                <span>Readers will no longer be able to access this blog</span>
            </div>
        </div>
        
        <!-- Hidden form to submit archive request -->
        <form id="archiveBlogForm" method="POST" action="">
            {% csrf_token %}
            <div class="archive-actions">
                <button type="button" class="cancel-archive-btn" onclick="hideArchiveCard()">
                    <i class="fas fa-times"></i> Keep Published
                </button>
                <button type="submit" class="confirm-archive-btn">
                    <i class="fas fa-archive"></i> Yes, Archive
                </button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/profile.js' %}"></script>
{% endblock %}